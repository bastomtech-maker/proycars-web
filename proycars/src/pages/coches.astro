---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import CarCard from '../components/CarCard.astro';

const allCoches = await getCollection('coches');

const cochesData = allCoches
  .map((entry) => entry.data)
  .sort((a, b) => {
    if (a.destacado !== b.destacado) return a.destacado ? -1 : 1;
    return b.año - a.año;
  });

const combustibles = [...new Set(cochesData.map((c) => c.combustible))].sort();
const transmisiones = [...new Set(cochesData.map((c) => c.transmision))].sort();
const estados = [...new Set(cochesData.map((c) => c.estado))].sort();
---

<BaseLayout title="Coches — Proycars" description="Descubre nuestro catálogo de vehículos de ocasión revisados y garantizados.">

  <!-- Page header -->
  <section class="container pt-10 sm:pt-14">
    <span class="badge badge-action mb-4 inline-block">Catálogo</span>
    <h1 class="mb-3">
      Nuestros <span class="text-brand-red">vehículos</span>
    </h1>
    <p class="max-w-xl text-lg text-text-secondary">
      Todos nuestros coches están revisados punto por punto y cuentan con garantía. Encuentra el tuyo.
    </p>
  </section>

  <!-- Catalog layout -->
  <section class="container py-8 sm:py-12">
    <div class="flex flex-col gap-6 lg:flex-row lg:gap-8">

      <!-- ===== FILTERS SIDEBAR ===== -->
      <aside class="w-full shrink-0 lg:w-64 xl:w-72">
        <!-- Mobile toggle -->
        <button
          id="filters-toggle"
          class="flex w-full items-center justify-between rounded-lg border border-surface-overlay bg-surface-raised px-4 py-3 text-sm font-semibold text-brand-white transition-colors hover:border-brand-red/30 lg:hidden"
          aria-expanded="false"
          aria-controls="filters-panel"
        >
          <span class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-brand-red" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
            </svg>
            Filtros y ordenación
          </span>
          <svg id="filters-chevron" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </button>

        <!-- Filters panel -->
        <div
          id="filters-panel"
          class="mt-3 hidden space-y-5 lg:mt-0 lg:block lg:sticky lg:top-24"
        >
          <div class="rounded-xl border border-surface-overlay bg-surface-raised p-4 sm:p-5">
            <!-- Sort -->
            <div class="mb-5">
              <label for="sort-select" class="mb-2 block text-xs font-semibold uppercase tracking-wider text-text-muted">
                Ordenar por
              </label>
              <select
                id="sort-select"
                class="w-full rounded-lg border border-surface-overlay bg-surface px-3 py-2.5 text-sm text-brand-white outline-none transition-colors focus:border-brand-red"
              >
                <option value="destacado">Destacados primero</option>
                <option value="precio-asc">Precio: menor a mayor</option>
                <option value="precio-desc">Precio: mayor a menor</option>
                <option value="año-desc">Año: más reciente</option>
                <option value="año-asc">Año: más antiguo</option>
                <option value="km-asc">Kilómetros: menor a mayor</option>
              </select>
            </div>

            <!-- Combustible -->
            <fieldset class="mb-5">
              <legend class="mb-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Combustible</legend>
              <div class="flex flex-col gap-2">
                {combustibles.map((c) => (
                  <label class="flex cursor-pointer items-center gap-2.5 text-sm text-text-secondary transition-colors hover:text-brand-white">
                    <input type="checkbox" value={c} name="combustible" class="filter-checkbox accent-brand-red" />
                    <span>{c}</span>
                  </label>
                ))}
              </div>
            </fieldset>

            <!-- Transmisión -->
            <fieldset class="mb-5">
              <legend class="mb-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Transmisión</legend>
              <div class="flex flex-col gap-2">
                {transmisiones.map((t) => (
                  <label class="flex cursor-pointer items-center gap-2.5 text-sm text-text-secondary transition-colors hover:text-brand-white">
                    <input type="checkbox" value={t} name="transmision" class="filter-checkbox accent-brand-red" />
                    <span>{t}</span>
                  </label>
                ))}
              </div>
            </fieldset>

            <!-- Estado -->
            <fieldset class="mb-5">
              <legend class="mb-2 text-xs font-semibold uppercase tracking-wider text-text-muted">Estado</legend>
              <div class="flex flex-col gap-2">
                {estados.map((e) => (
                  <label class="flex cursor-pointer items-center gap-2.5 text-sm text-text-secondary transition-colors hover:text-brand-white">
                    <input type="checkbox" value={e} name="estado" class="filter-checkbox accent-brand-red" />
                    <span>{e}</span>
                  </label>
                ))}
              </div>
            </fieldset>

            <!-- Reset -->
            <button
              id="filters-reset"
              class="btn btn-ghost btn-sm w-full text-text-muted hover:text-brand-white"
            >
              Limpiar filtros
            </button>
          </div>
        </div>
      </aside>

      <!-- ===== CATALOG GRID ===== -->
      <div class="min-w-0 flex-1">
        <!-- Results count -->
        <div class="mb-4 flex items-center justify-between">
          <p id="results-count" class="text-sm text-text-muted">
            <span id="visible-count">{cochesData.length}</span> de {cochesData.length} vehículos
          </p>
          <!-- Active filters (desktop inline) -->
          <div id="active-filters" class="hidden flex-wrap gap-1.5 sm:flex"></div>
        </div>

        <!-- No results message -->
        <div id="no-results" class="hidden rounded-xl bg-surface-raised p-8 text-center sm:p-12">
          <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto mb-4 h-12 w-12 text-text-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <p class="text-lg font-semibold text-brand-white">No se encontraron vehículos</p>
          <p class="mt-1 text-sm text-text-muted">Prueba a modificar los filtros para ver más resultados.</p>
        </div>

        <!-- Car grid -->
        <div id="car-grid" class="grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-3 sm:gap-6">
          {cochesData.map((coche) => (
            <div
              class="car-grid-item"
              data-precio={coche.precio}
              data-año={coche.año}
              data-km={coche.kilometros}
              data-combustible={coche.combustible}
              data-transmision={coche.transmision}
              data-estado={coche.estado}
              data-destacado={coche.destacado ? '1' : '0'}
            >
              <CarCard
                marca={coche.marca}
                modelo={coche.modelo}
                año={coche.año}
                precio={coche.precio}
                kilometros={coche.kilometros}
                combustible={coche.combustible}
                transmision={coche.transmision}
                potencia={coche.potencia}
                imagen={coche.imagenes[0]}
                estado={coche.estado}
                destacado={coche.destacado}
                slug={coche.slug}
              />
            </div>
          ))}
        </div>
      </div>

    </div>
  </section>

</BaseLayout>

<script>
  // ===== FILTER & SORT ENGINE =====
  const grid = document.getElementById('car-grid')!;
  const items = Array.from(grid.querySelectorAll<HTMLElement>('.car-grid-item'));
  const sortSelect = document.getElementById('sort-select') as HTMLSelectElement;
  const visibleCount = document.getElementById('visible-count')!;
  const noResults = document.getElementById('no-results')!;
  const filtersToggle = document.getElementById('filters-toggle');
  const filtersPanel = document.getElementById('filters-panel')!;
  const filtersChevron = document.getElementById('filters-chevron');
  const filtersReset = document.getElementById('filters-reset');
  const checkboxes = document.querySelectorAll<HTMLInputElement>('.filter-checkbox');
  const activeFiltersContainer = document.getElementById('active-filters')!;

  // Mobile toggle
  filtersToggle?.addEventListener('click', () => {
    const isOpen = !filtersPanel.classList.contains('hidden');
    filtersPanel.classList.toggle('hidden');
    filtersToggle.setAttribute('aria-expanded', String(!isOpen));
    filtersChevron?.classList.toggle('rotate-180');
  });

  // Gather active filters
  function getActiveFilters(): Record<string, string[]> {
    const filters: Record<string, string[]> = {};
    checkboxes.forEach((cb) => {
      if (cb.checked) {
        const name = cb.name;
        if (!filters[name]) filters[name] = [];
        filters[name].push(cb.value);
      }
    });
    return filters;
  }

  // Apply filters + sort
  function applyFiltersAndSort() {
    const filters = getActiveFilters();
    const sortValue = sortSelect.value;
    let visible = 0;

    // Filter
    items.forEach((item) => {
      let show = true;
      for (const [key, values] of Object.entries(filters)) {
        const itemValue = item.dataset[key] || '';
        if (!values.includes(itemValue)) {
          show = false;
          break;
        }
      }
      item.style.display = show ? '' : 'none';
      item.dataset.visible = show ? '1' : '0';
      if (show) visible++;
    });

    // Sort visible items
    const visibleItems = items.filter((i) => i.dataset.visible === '1');
    visibleItems.sort((a, b) => {
      switch (sortValue) {
        case 'precio-asc':
          return Number(a.dataset.precio) - Number(b.dataset.precio);
        case 'precio-desc':
          return Number(b.dataset.precio) - Number(a.dataset.precio);
        case 'año-desc':
          return Number(b.dataset['año']) - Number(a.dataset['año']);
        case 'año-asc':
          return Number(a.dataset['año']) - Number(b.dataset['año']);
        case 'km-asc':
          return Number(a.dataset.km) - Number(b.dataset.km);
        case 'destacado':
        default:
          return Number(b.dataset.destacado) - Number(a.dataset.destacado)
            || Number(b.dataset['año']) - Number(a.dataset['año']);
      }
    });

    // Reorder DOM
    visibleItems.forEach((item) => grid.appendChild(item));
    // Append hidden items at end
    items.filter((i) => i.dataset.visible !== '1').forEach((item) => grid.appendChild(item));

    // Update count
    visibleCount.textContent = String(visible);
    noResults.classList.toggle('hidden', visible > 0);
    grid.classList.toggle('hidden', visible === 0);

    // Update active filter pills
    renderActiveFilters(filters);
  }

  // Render active filter pills
  function renderActiveFilters(filters: Record<string, string[]>) {
    activeFiltersContainer.innerHTML = '';
    const hasFilters = Object.values(filters).some((v) => v.length > 0);
    activeFiltersContainer.classList.toggle('hidden', !hasFilters);
    activeFiltersContainer.classList.toggle('flex', hasFilters);

    for (const [, values] of Object.entries(filters)) {
      values.forEach((val) => {
        const pill = document.createElement('button');
        pill.className = 'inline-flex items-center gap-1 rounded-full bg-brand-red/15 px-2.5 py-0.5 text-xs font-medium text-brand-red-light transition-colors hover:bg-brand-red/25';
        pill.innerHTML = `${val} <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>`;
        pill.addEventListener('click', () => {
          // Uncheck the matching checkbox
          checkboxes.forEach((cb) => {
            if (cb.value === val && cb.checked) cb.checked = false;
          });
          applyFiltersAndSort();
        });
        activeFiltersContainer.appendChild(pill);
      });
    }
  }

  // Event listeners
  sortSelect.addEventListener('change', applyFiltersAndSort);
  checkboxes.forEach((cb) => cb.addEventListener('change', applyFiltersAndSort));

  // Reset
  filtersReset?.addEventListener('click', () => {
    checkboxes.forEach((cb) => (cb.checked = false));
    sortSelect.value = 'destacado';
    applyFiltersAndSort();
  });

  // Close filters on desktop resize
  window.addEventListener('resize', () => {
    if (window.innerWidth >= 1024) {
      filtersPanel.classList.remove('hidden');
    }
  });
</script>
